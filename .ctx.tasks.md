# Harbor Audit Fix Plan

## Overview
31 issues logged from full project audit. Organized into 5 phases by dependency order and severity.

## Completed
- #90 Extract shared utilities → `src/utils/formatting.ts` ✅
- #91 Decompose Settings.tsx → split into 5 section components ✅
- Phase 0 (Port Community Boards) → **No porting needed.** Harbor already has the full implementation and is ahead of ai-harbor on relay security (signature verification, rate limiting, lamport clocks). Differences are only error type naming. If boards aren't working, it's a runtime/deployment issue, not missing code. ✅

---

## Phase 0: Port Community Boards from ai-harbor
**Priority**: Immediate — core feature, fork already has working implementation
**Source**: `/home/bakobi/repos/ai-harbor` (fork, commit `40d3e07`)
**Branch**: `feat/community-boards`

### Summary
The ai-harbor fork implemented a full community boards system with relay-side storage, cryptographic signing, lamport clock validation, and offline-first local caching. Harbor needs to port these changes to get community boards working.

### Files to Copy/Port from ai-harbor

**New files to add:**
| File | Description |
|------|-------------|
| `src-tauri/src/db/repositories/boards_repo.rs` | Local board/community cache (relay_communities, boards, board_posts, sync cursors) |
| `src-tauri/src/db/migrations/008_boards.sql` | DB schema for boards local cache |
| `src-tauri/src/commands/boards.rs` | Tauri command handlers (join/leave community, get boards/posts, submit/delete) |
| `src-tauri/src/p2p/protocols/board_sync.rs` | Wire protocol types (BoardSyncRequest/Response enums) |

**Files to update (merge ai-harbor changes):**
| File | What changed |
|------|-------------|
| `relay-server/src/board_service.rs` | Add signature verification (Ed25519) for ALL operations, signable types |
| `relay-server/src/db.rs` | Add `author_lamport_clocks` table, `get_last_lamport_clock()`, `update_lamport_clock()` |
| `relay-server/src/main.rs` | Integrate board_sync protocol, auth checking |
| `src-tauri/src/services/board_service.rs` | Full client-side logic: signed request creation, local cache management |
| `src-tauri/src/services/signing.rs` | Add board-related signable types (SignableBoardPost, SignablePeerRegistration, etc.) |
| `src-tauri/src/p2p/network.rs` | Add board command handlers (join_community, list_boards, submit_post, etc.) |
| `src-tauri/src/lib.rs` | Register board commands and services |
| `src-tauri/src/db/mod.rs` | Register boards_repo |
| `src/stores/boards.ts` | Full Zustand store with communities, boards, posts, pagination |
| `src/services/boards.ts` | Tauri invoke wrappers |
| `src/types/boards.ts` | TypeScript interfaces (CommunityInfo, BoardInfo, BoardPost) |
| `src/pages/Boards.tsx` | Full UI: community selector, board tabs, post composer, feed with infinite scroll |

### Key Security Features to Port
1. **Signature verification on every write** — relay verifies Ed25519 signatures
2. **Lamport clock validation** — prevents replay attacks (reject clock <= last seen)
3. **Peer registration** — first registration stores public key, future ops verified against it
4. **CBOR canonical encoding** — deterministic signature payloads

### Approach
1. Diff ai-harbor files against harbor equivalents to identify exact deltas
2. Copy new files directly, adapting imports/module structure as needed
3. Merge changes into existing files, resolving conflicts with harbor's current state
4. Wire up module registrations (lib.rs, mod.rs files)
5. Run `dev fix` and `dev ci` to validate
6. Test end-to-end with relay server + client

---

## Phase 1: Critical Security Fixes
**Priority**: Immediate — blocks production readiness
**Branch**: `fix/critical-security`

| Task | Issue | Status | Files |
|------|-------|--------|-------|
| Implement signature verification in relay server | #69 | pending | `relay-server/src/board_service.rs`, `relay-server/src/main.rs` |
| Implement signature verification in identity exchange | #70 | pending | `src-tauri/src/p2p/network.rs:1614` |
| Fix updater config (pubkey + GitHub URL) | #71 | pending | `src-tauri/tauri.conf.json` |
| Remove hardcoded identity key from CloudFormation | #72 | pending | `infrastructure/community-relay-cloudformation.yaml` |
| Add Content Security Policy | #80 | pending | `src-tauri/tauri.conf.json` |
| Validate Lamport clock in relay server | #83 | pending | `relay-server/src/board_service.rs` |
| Fix nonce generation in mock-peer | #84 | pending | `mock-peer/src/main.rs` |
| Restrict SSH security group | #86 | pending | `infrastructure/libp2p-relay-cloudformation.yaml` |

### Approach
1. **Signature verification (relay)**: Add ed25519 verification using the `ed25519-dalek` crate. Before storing any post in `board_service.rs`, verify the signature against the author's public key. Reject with 401 if verification fails.
2. **Signature verification (P2P)**: In `network.rs` at the identity exchange handler, verify the signed identity response. Extract the public key from the identity and verify the signature field matches.
3. **Updater config**: Generate a real updater keypair with `tauri signer generate`, update `tauri.conf.json` with the correct pubkey and fix the GitHub URL to `bakobiibizo/harbor`.
4. **CloudFormation identity key**: Replace hardcoded key with a UserData script that generates a new identity on first boot. Store in instance-local storage.
5. **CSP**: Add restrictive CSP: `"default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'"`.
6. **Lamport clock**: Track last-seen clock per author in relay DB. Reject posts with clock <= last seen.
7. **Nonce**: Switch mock-peer to random nonce generation via `rand` crate.
8. **SSH**: Make SSH security group rule conditional on `HasKeyPair` condition.

---

## Phase 2: Stability & Error Handling
**Priority**: High — prevents crashes and data loss
**Branch**: `fix/stability`

| Task | Issue | Status | Files |
|------|-------|--------|-------|
| Replace unsafe unwrap() with error handling | #73 | pending | 43+ files in `src-tauri/src/` |
| Fix setInterval leak in Network.tsx | #75 | pending | `src/pages/Network.tsx` |
| Add .catch() to fire-and-forget async calls | #76 | pending | `src/stores/messaging.ts`, `src/stores/boards.ts` |
| Add try-catch to useTauriEvents handlers | #89 | pending | `src/hooks/useTauriEvents.ts` |
| Add global unhandled promise rejection handler | #97 | pending | `src/App.tsx` or `src/main.tsx` |
| Refactor error codes from string matching to typed | #81 | pending | `src-tauri/src/error.rs` |

### Approach
1. **Unwrap replacement**: Systematically replace `lock().unwrap()` with a helper: `fn acquire_lock<T>(lock: &Mutex<T>) -> Result<MutexGuard<T>, AppError>` that handles poisoned mutexes. Apply across all DB repos and services.
2. **setInterval**: Add `return () => clearInterval(interval)` in the useEffect cleanup.
3. **Async catches**: Add `.catch(err => console.error(...))` to all fire-and-forget calls, or convert to proper awaits.
4. **Event try-catch**: Wrap each case in `useTauriEvents` switch with try-catch.
5. **Global rejection handler**: Add in `main.tsx`: `window.addEventListener('unhandledrejection', handler)`.
6. **Typed errors**: Create specific error variants: `AppError::IdentityLocked`, `AppError::IdentityNotFound`, etc. Replace string matching in `error.rs`.

---

## Phase 3: Infrastructure & Config
**Priority**: Medium — correctness and deployment
**Branch**: `fix/infrastructure`

| Task | Issue | Status | Files |
|------|-------|--------|-------|
| Align version numbers | #79 | pending | All `Cargo.toml` files, `package.json`, `tauri.conf.json` |
| Update infra README (remove Docker refs) | #77 | pending | `infrastructure/README.md` |
| Add rate limiting to relay server | #78 | pending | `relay-server/src/main.rs` |
| Refactor SQL format!() patterns | #82 | pending | `likes_repo.rs`, `bootstrap_repo.rs` |
| Optimize 1000-row query | #85 | pending | `src-tauri/src/services/content_sync_service.rs` |
| Implement message ACK processing | #74 | pending | `src-tauri/src/p2p/network.rs` |

### Approach
1. **Versions**: Set all crates and configs to `0.2.0`.
2. **README**: Rewrite deployment section to match actual CloudFormation UserData (binary compilation, no Docker).
3. **Rate limiting**: Add `tower::limit::RateLimitLayer` to the relay server's axum router — 60 requests/minute per IP.
4. **SQL**: Add safety comments to existing `format!()` usage. Consider switching to a query builder for new queries.
5. **Query optimization**: Add SQL WHERE clause for the time-based filter instead of fetching 1000 rows.
6. **ACK processing**: On receiving ACK, call `MessagesRepository::update_status(message_id, "delivered")` and emit `message_status_changed` event to frontend.

---

## Phase 4: Code Quality & Refactoring
**Priority**: Medium-Low — maintainability
**Branch**: `refactor/code-quality`

| Task | Issue | Status | Files |
|------|-------|--------|-------|
| Extract shared utility functions | #90 | pending | Create `src/utils/formatting.ts` |
| Decompose Settings.tsx | #91 | pending | `src/pages/Settings.tsx` → sub-components |
| Remove dead code | #93 | pending | `calling_service.rs`, `network.rs` |
| Refactor high-arity functions | #94 | pending | Commands and repo files |
| Replace console.log with structured logging | #87 | pending | 15+ frontend files |
| Break down network event loop | #88 | pending | `src-tauri/src/p2p/network.rs` |
| Add useMemo optimizations | #98 | pending | `Chat.tsx`, `Network.tsx` |
| Implement keyboard navigation | #92 | pending | `src/hooks/useKeyboardNavigation.ts` |

### Approach
1. **Shared utils**: Create `src/utils/formatting.ts` with `getInitials()`, `getContactColor()`, `formatDate()`, `shortPeerId()`. Update all imports.
2. **Settings decomposition**: Split into `ProfileSection.tsx`, `SecuritySection.tsx`, `NetworkSection.tsx`, `PrivacySection.tsx`. Settings.tsx becomes a layout wrapper.
3. **Dead code**: Remove `db` field from `calling_service.rs` and `FALLBACK_RELAYS` from `network.rs`.
4. **High-arity**: Create param structs like `CreatePostParams`, `NetworkStartParams` for functions with 6+ parameters.
5. **Logging**: Create `src/utils/logger.ts` wrapper (if not already comprehensive) and replace all `console.*` calls.
6. **Network event loop**: Extract handlers into `handle_kademlia_event()`, `handle_mdns_event()`, `handle_gossipsub_event()`, etc.
7. **useMemo**: Wrap `searchResults` and `getPeerFriendlyName` hash computations.
8. **Keyboard nav**: Implement shortcuts using existing page navigation and list selection logic.

---

## Phase 5: Testing & Documentation
**Priority**: Low — long-term quality
**Branch**: `test/coverage`

| Task | Issue | Status | Files |
|------|-------|--------|-------|
| Backend service tests | #95 | pending | `src-tauri/src/services/` |
| Frontend page/component tests | #96 | pending | `src/__tests__/` |
| Document mock vs real boundaries | #99 | pending | Root-level doc or README |

### Approach
1. **Backend tests**: Add integration tests for `messaging_service`, `feed_service`, `content_sync_service`, `board_service`, `calling_service`. Add command handler tests using mock Tauri state.
2. **Frontend tests**: Set up Vitest + React Testing Library. Add tests for each page's core interactions. Add hook tests for `useTauriEvents`.
3. **Mock documentation**: Add a section to CLAUDE.md or create `MOCK_STATUS.md` listing each feature and whether it uses mock or real data.

---

## Issue Cross-Reference

| Issue | Title | Phase | Severity |
|-------|-------|-------|----------|
| #69 | Signature verification — relay server | 1 | Critical |
| #70 | Signature verification — identity exchange | 1 | Critical |
| #71 | Fix updater config | 1 | Critical |
| #72 | Remove hardcoded identity key | 1 | Critical |
| #73 | Replace unsafe unwrap() calls | 2 | High |
| #74 | Message ACK processing | 3 | High |
| #75 | Fix setInterval leak | 2 | High |
| #76 | Add async error handling | 2 | High |
| #77 | Update infra README | 3 | High |
| #78 | Rate limiting — relay server | 3 | High |
| #79 | Align version numbers | 3 | High |
| #80 | Add CSP | 1 | Medium |
| #81 | Refactor error codes | 2 | High |
| #82 | Refactor SQL format!() | 3 | Medium |
| #83 | Validate Lamport clock | 1 | Medium |
| #84 | Fix nonce generation | 1 | Medium |
| #85 | Optimize post query | 3 | Medium |
| #86 | Restrict SSH security group | 1 | Medium |
| #87 | Structured logging | 4 | Medium |
| #88 | Break down event loop | 4 | Medium |
| #89 | Add try-catch to events | 2 | Medium |
| #90 | Extract shared utilities | 4 | Low |
| #91 | Decompose Settings.tsx | 4 | Low |
| #92 | Keyboard navigation | 4 | Low |
| #93 | Remove dead code | 4 | Low |
| #94 | Refactor high-arity functions | 4 | Low |
| #95 | Backend service tests | 5 | Low |
| #96 | Frontend tests | 5 | Low |
| #97 | Global rejection handler | 2 | Low |
| #98 | Add useMemo optimizations | 4 | Low |
| #99 | Document mock boundaries | 5 | Low |
